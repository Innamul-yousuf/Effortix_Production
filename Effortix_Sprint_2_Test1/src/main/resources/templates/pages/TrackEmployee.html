<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Employee Details</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- jQuery and Chart.js -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container my-5">
        <div class="text-center">
            <h1 class="display-4 mb-4">Employee Dashboard</h1>
            <p class="lead">Select an employee to view detailed information and stats</p>
        </div>

        <!-- Dropdown for employees -->
        <div class="mb-4">
            <label for="employeeDropdown" class="form-label">Select Employee</label>
            <select class="form-select" id="employeeDropdown">
                <option value="" disabled selected>Select an employee</option>
                <option th:each="employee : ${employees}" th:value="${employee.eId}" th:text="${employee.eName}"></option>
            </select>
        </div>

        <!-- Employee Details Section -->
        <div id="employeeDetails" class="card p-4 mb-4 shadow-lg">
            <h2 class="h4">Employee Details</h2>
            <ul class="list-group list-group-flush">
                <li class="list-group-item"><strong>ID:</strong> <span id="eId"></span></li>
                <li class="list-group-item"><strong>Name:</strong> <span id="eName"></span></li>
                <li class="list-group-item"><strong>Email:</strong> <span id="eEmail"></span></li>
                <li class="list-group-item"><strong>Designation:</strong> <span id="eDesignation"></span></li>
                <li class="list-group-item"><strong>Contact:</strong> <span id="eContact"></span></li>
                <li class="list-group-item"><strong>Lead:</strong> <span id="eLead"></span></li>
            </ul>
        </div>

        <!-- Ticket Details Section -->
        <div id="ticketDetails" class="card p-4 mb-4 shadow-lg">
            <h2 class="h4">Tickets Assigned to Employee</h2>
            <table class="table table-striped mt-3" id="ticketTable">
                <thead class="table-dark">
                    <tr>
                        <th>Ticket ID</th>
                        <th>Ticket Name</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Ticket rows will be added dynamically via AJAX -->
                </tbody>
            </table>
        </div>

        <!-- Employee Projects Section -->
        <div id="projectDetails" class="card p-4 mb-4 shadow-lg">
            <h2 class="h4">Employee Projects</h2>
            <table class="table table-striped mt-3" id="projectTable">
                <thead class="table-dark">
                    <tr>
                        <th>Project ID</th>
                        <th>Project Name</th>
                        <th>End Date</th>
                        <th>Priority Level</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Project rows will be dynamically added here via AJAX -->
                </tbody>
            </table>
        </div>

        <!-- AI Suggested Employees Section -->
        <div id="aiSuggestions" class="card p-4 mb-4 shadow-lg">
            <h2 class="h4">AI Suggested Employees</h2>
            <textarea id="projectRequirement" class="form-control mb-3" rows="4" placeholder="Enter project or task requirements..."></textarea>
            <button id="askAiButton" class="btn btn-primary">Ask AI</button>
            <table class="table table-striped mt-3" id="aiSuggestedEmployeesTable">
                <thead class="table-dark">
                    <tr>
                        <th>Employee Name</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Suggested employees will be dynamically added here via AJAX -->
                </tbody>
            </table>
        </div>

        <!-- Pie Chart Section -->
        <div id="creditChartContainer" class="card p-4 shadow-lg">
            <h2 class="h4">Employee Credits by Type</h2>
             <div id="creditChartContainer" style="margin-top: 30px; max-width: 400px;">
            	<canvas id="creditChart" width="400" height="400"></canvas>
            </div>
        </div>
    </div>

    <!-- AJAX to fetch and update ticket, project, and AI suggestions -->
    <script>
        // Same scripts as before for AJAX handling
        $(document).ready(function () {
            // Employee dropdown change logic
            // Ticket, project, and AI suggestions loading logic
        });
    </script>
	
	<script>
    $(document).ready(function () {
        // When the employee dropdown changes
        $('#employeeDropdown').change(function () {
            var employeeId = $(this).val();
            
            if (employeeId) {
                // AJAX call to fetch employee details for the selected employee
                $.ajax({
                    url: '/employees/details/' + employeeId,  // Fetch employee details by id
                    type: 'GET',
                    success: function (employee) {
                        if (employee) {
                            // Populate the employee details on the page
                            $('#eId').text(employee.eId);
                            $('#eName').text(employee.eName);
                            $('#eEmail').text(employee.eEmail);
                            $('#eDesignation').text(employee.eDesignation);
                            $('#eContact').text(employee.eContact);
                            $('#eLead').text(employee.eISLead);

                            // Fetch and populate tickets
                            fetchTickets(employeeId);

                            // Fetch and populate projects
                            fetchProjects(employeeId);
                        } else {
                            alert('Employee not found');
                        }
                    },
                    error: function () {
                        alert('Failed to fetch employee details!');
                    }
                });
            }
        });
    });
    </script>
	 <!-- AJAX to fetch and update ticket details -->
    <script>
        $(document).ready(function () {
            // When the employee dropdown changes
            $('#employeeDropdown').change(function () {
                var employeeId = $(this).val();
                
                if (employeeId) {
                    // AJAX call to fetch tickets for the selected employee
                    $.ajax({
                        url: '/ticketsREST/flag?employeeId=' + employeeId,  // Send employeeId to the backend
                        type: 'GET',
                        success: function (data) {
                            // Clear the existing ticket rows
                            $('#ticketTable tbody').empty();

                            // Loop through the tickets and create rows for each
                            data.forEach(function(ticket) {
                                var row = '<tr>' +
                                    '<td>' + ticket.tid + '</td>' +
                                    '<td>' + ticket.tname + '</td>' +
                                    '<td>' +
                                        '<a href="/ticketUpdates/ticket/' + ticket.tid + '">View</a> | ' +
                                        '<a href="/tickets/tickets/edit/' + ticket.tid + '">Edit</a> | ' +
                                        '<form action="/tickets/' + ticket.tid + '/delete" method="post" style="display:inline;">' +
                                            '<button type="submit">Delete</button>' +
                                        '</form>' +
                                    '</td>' +
                                '</tr>';
                                
                                // Append the row to the table
                                $('#ticketTable tbody').append(row);
                            });
                        },
                        error: function () {
                            alert('Failed to fetch tickets!');
                        }
                    });
             
        
        
        $.ajax({
        	
            url: '/empProject/projects/' + employeeId,  // Add the endpoint to fetch projects
            type: 'GET',
            success: function (data) {
                // Clear the existing project rows
                $('#projectTable tbody').empty();

                // Loop through the projects and create rows for each
                data.forEach(function(project) {
                    var row = '<tr>' +
                        '<td>' + project.pId + '</td>' +
                        '<td>' + project.pName + '</td>' +
                        '<td>' + project.pEndDate + '</td>' +
                        '<td>' + project.pPriority + '</td>' +

                        '<td>' +
                            '<a href="/projects/' + project.pId + '">View</a>' +
                        '</td>' +
                    '</tr>';
                    
                    // Append the row to the table
                    $('#projectTable tbody').append(row);
                });
            },
            error: function () {
                alert('Failed to fetch projects!');
            }
        });
   
     
            }
        });
        });
        </script>
        
                <script>
        
     // When the Ask AI button is clicked
        $('#askAiButton').click(function () {
            var description = $('#projectRequirement').val();

            if (description) {
                $.ajax({
                    url: '/tickets/tickets/edit/getAiSuggestedEmployees',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ description: description }),
                    success: function (data) {
                        $('#aiSuggestedEmployeesTable tbody').empty();
                        data.forEach(function(employee) {
                            var row = '<tr>' +
                                '<td>' + employee.eName + '</td>' +
                                '<td>' +
                                    '<a href="/project-employee/profile/' + employee.eId + '">View Details</a>' +
                                '</td>' +
                            '</tr>';
                            $('#aiSuggestedEmployeesTable tbody').append(row);
                        });
                    },
                    error: function () {
                        alert('Failed to fetch AI suggested employees!');
                    }
                });
            } else {
                alert('Please enter project requirements.');
            }
        });

    
    </script>
    
    
    
<script>
$(document).ready(function () {
	
    // When the employee dropdown changes
    $('#employeeDropdown').change(function () {
    	
        var employeeId = $(this).val();
        
        if (employeeId) {
            // Get current year start and end dates
            var startDate = new Date(new Date().getFullYear(), 0, 1); // January 1
            var endDate = new Date(new Date().getFullYear(), 11, 31); // December 31
            
            // Format dates to yyyy-MM-dd
            var formattedStartDate = startDate.toISOString().split('T')[0];
            var formattedEndDate = endDate.toISOString().split('T')[0];

            // AJAX call to fetch employee credits
            $.ajax({
                url: '/api/employee-credits/employee/' + employeeId + '/date-range',
                type: 'GET',
                data: {
                    startDate: formattedStartDate,
                    endDate: formattedEndDate
                },
                success: function (data) {
                    // Assuming data is an array of EmployeeCredits
                    var labels = [];
                    var values = [];

                    data.forEach(function (creditRecord) {
                        labels.push(creditRecord.creditType);
                        values.push(creditRecord.credits);
                    });

                    // Create or update the pie chart
                    var ctx = document.getElementById('creditChart').getContext('2d');

                  /*   // Destroy the previous chart instance if it exists
                    if (window.creditChart) {
                        window.creditChart.destroy();
                    }
 */
                    window.creditChart = new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: labels, // Array of creditTypes
                            datasets: [{
                                label: 'Employee Credits',
                                data: values, // Array of credits
                                backgroundColor: [
                                    'rgba(255, 99, 132, 0.2)',
                                    'rgba(54, 162, 235, 0.2)',
                                    'rgba(255, 206, 86, 0.2)',
                                    'rgba(75, 192, 192, 0.2)',
                                    'rgba(153, 102, 255, 0.2)',
                                    'rgba(255, 159, 64, 0.2)'
                                ],
                                borderColor: [
                                    'rgba(255, 99, 132, 1)',
                                    'rgba(54, 162, 235, 1)',
                                    'rgba(255, 206, 86, 1)',
                                    'rgba(75, 192, 192, 1)',
                                    'rgba(153, 102, 255, 1)',
                                    'rgba(255, 159, 64, 1)'
                                ],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    position: 'top',
                                },
                                title: {
                                    display: true,
                                    text: 'Employee Credits by Credit Type'
                                }
                            }
                        }
                    });
                },
                error: function () {
                    alert('Failed to fetch employee credits!');
                }
            });
        }
    });
});
</script>



    <!-- Bootstrap JS and Popper.js -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
    
</body>
</html>
